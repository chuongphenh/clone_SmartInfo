<?xml version="1.0" encoding="utf-8"?>
<report xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
	<save_as_file_name>Danh sách nhân sự</save_as_file_name>
	<templates>
		<template file_name="Excel_DanhSach_NguoiDung.xlsx" paper_size="A4" is_default="true" />
	</templates>
	<render_infos>
		<render_info>
			<source_dynamic>
				<![CDATA[
								--SELECT 
--									ROW_NUMBER() OVER (ORDER BY emp.EmployeeID) AS STT,
--	                                emp.EmployeeCode as employeeCode, 
--									emp.Name as name, 
--									emp.Username as userName, 
--									emp.Sector as sectorName,
--									emp.DOB as dob, 
--									CASE emp.Gender
--										WHEN 0 THEN 'Nam'
--										WHEN 1 THEN N'Nữ'
--										ELSE ''
--									END AS genderName,
--									emp.Phone as phone, 
--									emp.Mobile as mobile, 
--									emp.Email as email,
--									CASE emp.Status 
--										WHEN 1 THEN N'Đang sử dụng'
--										WHEN 2 THEN N'Không sử dụng'
--										ELSE ''
--									END as statusName, 
--									emp.Description as description,
--									emp.Level as levelName, 
--									emp.ListBranchCode as listBranchCode,
--									--emp.AuthorizationType as authorizationTypeName, 
--	                                v.DepartmentName as organizationName, 
--									CASE 
--										WHEN v.OrganizationOfManagerName is null THEN ''
--										ELSE N'Quản lý'
--									END as positionName
--                                FROM adm_Employee emp
--	                                LEFT JOIN adm_EmployeeRole enRole on emp.EmployeeID= enRole.EmployeeID
--	                                LEFT JOIN
--	                                (
--		                                --Lay phong chuyen vien thuoc ve
--		                                select enEmployee.EmployeeID, emEmpBreadCrum.BreadCrumb as DepartmentName, null as OrganizationOfManagerName
--		                                from adm_Employee as enEmployee
--		                                inner join OrganizationEmployee as enOrganizationEmployee on enEmployee.EmployeeID = enOrganizationEmployee.EmployeeID
--		                                inner join vOrganization as emEmpBreadCrum on enOrganizationEmployee.OrganizationID = emEmpBreadCrum.OrganizationID
	    
--		                                union

--		                                --Lay phong ma chuyen vien la quan ly
--		                                select enEmployee.EmployeeID, null as DepartmentName, enManagerOrg.BreadCrumb as OrganizationOfManagerName
--		                                from adm_Employee as enEmployee
--		                                inner join OrganizationManager as enOrgMng on enOrgMng.Deleted=0
--				                                and enOrgMng.EmployeeID = enEmployee.EmployeeID 
--		                                inner join vOrganization as enManagerOrg on enOrgMng.OrganizationID = enManagerOrg.OrganizationID
--	                                ) v on emp.EmployeeID = v.EmployeeID
                                

--                                --Neu tim theo Nhieu role hoac ko theo role -> Khi Emp co nhieu Role -> Loai cac Role thua
--                                GROUP BY emp.EmployeeID, emp.Name, emp.Username, emp.Status, emp.Email, emp.EmployeeCode, emp.Sector,
--								emp.DOB, emp.Gender, emp.Status, emp.Description, emp.Level, emp.ListBranchCode, emp.AuthorizationType, emp.Phone, emp.Mobile,
--	                                v.DepartmentName, v.OrganizationOfManagerName
                            WITH EmployeeGroups AS (
                                SELECT
                                    empRole.EmployeeID,
                                    MAX(CASE WHEN LOWER(role.Name) = LOWER('Nhóm 1') THEN 'x' ELSE '' END) AS Group1,
                                    MAX(CASE WHEN LOWER(role.Name) = LOWER('Nhóm 2') THEN 'x' ELSE '' END) AS Group2,
                                    MAX(CASE WHEN LOWER(role.Name) = LOWER('Nhóm 3') THEN 'x' ELSE '' END) AS Group3,
                                    MAX(CASE WHEN LOWER(role.Name) = LOWER('Nhóm 4') THEN 'x' ELSE '' END) AS Group4,
                                    MAX(CASE WHEN LOWER(role.Name) = LOWER('Nhóm 5') THEN 'x' ELSE '' END) AS Group5,
                                    MAX(CASE WHEN LOWER(role.Name) = LOWER('Nhóm 6') THEN 'x' ELSE '' END) AS Group6,
                                    MAX(CASE WHEN LOWER(role.Name) = LOWER('Nhóm 7') THEN 'x' ELSE '' END) AS Group7,
                                    MAX(CASE WHEN LOWER(role.Name) = LOWER('Nhóm 8') THEN 'x' ELSE '' END) AS Group8,
                                    MAX(CASE WHEN LOWER(role.Name) = LOWER('Nhóm 9') THEN 'x' ELSE '' END) AS Group9,
                                    MAX(CASE WHEN LOWER(role.Name) = LOWER('Nhóm 10') THEN 'x' ELSE '' END) AS Group10
                                FROM
                                    adm_EmployeeRole empRole
                                    JOIN adm_Role role ON empRole.RoleID = role.RoleID
                                GROUP BY
                                    empRole.EmployeeID
                            )

                            SELECT 
                                ROW_NUMBER() OVER (ORDER BY emp.EmployeeID) AS STT,
                                emp.EmployeeCode AS employeeCode, 
                                emp.Name AS name, 
                                emp.Username AS userName, 
                                emp.Sector AS sectorName,
                                emp.DOB AS dob, 
                                CASE emp.Gender
                                    WHEN 0 THEN 'Nam'
                                    WHEN 1 THEN N'Nữ'
                                    ELSE ''
                                END AS genderName,
                                emp.Phone AS phone, 
                                emp.Mobile AS mobile, 
                                emp.Email AS email,
                                CASE emp.Status 
                                    WHEN 1 THEN N'Đang sử dụng'
                                    WHEN 2 THEN N'Không sử dụng'
                                    ELSE ''
                                END AS statusName, 
                                emp.Description AS description,
                                emp.Level AS levelName, 
                                v.DepartmentName AS organizationName, 
                                emp.ListBranchCode AS listBranchCode,
                                CASE 
                                    WHEN v.OrganizationOfManagerName IS NULL THEN ''
                                    ELSE N'Quản lý'
                                END AS positionName,
                                eg.Group1,
                                eg.Group2,
                                eg.Group3,
                                eg.Group4,
                                eg.Group5,
                                eg.Group6,
                                eg.Group7,
                                eg.Group8,
                                eg.Group9,
                                eg.Group10
                            FROM
                                adm_Employee emp
                                LEFT JOIN (
                                    SELECT 
                                        enEmployee.EmployeeID, 
                                        emEmpBreadCrum.BreadCrumb AS DepartmentName, 
                                        NULL AS OrganizationOfManagerName
                                    FROM 
                                        adm_Employee AS enEmployee
                                        INNER JOIN OrganizationEmployee AS enOrganizationEmployee ON enEmployee.EmployeeID = enOrganizationEmployee.EmployeeID
                                        INNER JOIN vOrganization AS emEmpBreadCrum ON enOrganizationEmployee.OrganizationID = emEmpBreadCrum.OrganizationID
        
                                    UNION ALL

                                    SELECT 
                                        enEmployee.EmployeeID, 
                                        NULL AS DepartmentName, 
                                        enManagerOrg.BreadCrumb AS OrganizationOfManagerName
                                    FROM 
                                        adm_Employee AS enEmployee
                                        INNER JOIN OrganizationManager AS enOrgMng ON enOrgMng.Deleted = 0 AND enOrgMng.EmployeeID = enEmployee.EmployeeID
                                        INNER JOIN vOrganization AS enManagerOrg ON enOrgMng.OrganizationID = enManagerOrg.OrganizationID
                                ) v ON emp.EmployeeID = v.EmployeeID
                                LEFT JOIN EmployeeGroups eg ON emp.EmployeeID = eg.EmployeeID;
        ]]>
			</source_dynamic>
			<virtual_table>
				<template_row_name>userName</template_row_name>
			</virtual_table>
		</render_info>
	</render_infos>
</report>
